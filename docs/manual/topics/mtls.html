<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Mutual TLS with Otoroshi · Otoroshi</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='otoroshi-manual'/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/cc.js"></script>
<script type="text/javascript" src="../js/groups.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/normalize.css/normalize.css"/>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>

<!--
<link rel="shortcut icon" href="../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>Otoroshi
</a>
<div class="version-number">
1.5.0-beta.4
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../about.html" class="page">About Otoroshi</a></li>
  <li><a href="../archi.html" class="page">Architecture</a></li>
  <li><a href="../features.html" class="page">Features</a></li>
  <li><a href="../quickstart.html" class="page">Try Otoroshi in 5 minutes</a></li>
  <li><a href="../getotoroshi/index.html" class="page">Get Otoroshi</a>
  <ul>
    <li><a href="../getotoroshi/fromsources.html" class="page">From sources</a></li>
    <li><a href="../getotoroshi/frombinaries.html" class="page">From binaries</a></li>
    <li><a href="../getotoroshi/fromdocker.html" class="page">From docker</a></li>
  </ul></li>
  <li><a href="../firstrun/index.html" class="page">First run</a>
  <ul>
    <li><a href="../firstrun/datastore.html" class="page">Choose your datastore</a></li>
    <li><a href="../firstrun/configfile.html" class="page">Config. with files</a></li>
    <li><a href="../firstrun/env.html" class="page">Config. with ENVs</a></li>
    <li><a href="../firstrun/initialstate.html" class="page">Import initial state</a></li>
    <li><a href="../firstrun/host.html" class="page">Setup your hosts</a></li>
    <li><a href="../firstrun/run.html" class="page">Run Otoroshi</a></li>
  </ul></li>
  <li><a href="../setup/index.html" class="page">Setup Otoroshi</a>
  <ul>
    <li><a href="../setup/admin.html" class="page">Manage admin users</a></li>
    <li><a href="../setup/dangerzone.html" class="page">Configure the Danger zone</a></li>
  </ul></li>
  <li><a href="../usage/index.html" class="page">Using Otoroshi</a>
  <ul>
    <li><a href="../usage/1-groups.html" class="page">Managing service groups</a></li>
    <li><a href="../usage/2-services.html" class="page">Managing services</a></li>
    <li><a href="../usage/3-apikeys.html" class="page">Managing API keys</a></li>
    <li><a href="../usage/4-monitor.html" class="page">Monitoring services</a></li>
    <li><a href="../usage/5-sessions.html" class="page">Managing sessions</a></li>
    <li><a href="../usage/6-audit.html" class="page">Auditing Otoroshi</a></li>
    <li><a href="../usage/7-metrics.html" class="page">Otoroshi global metrics</a></li>
    <li><a href="../usage/8-importsexports.html" class="page">Import and export</a></li>
    <li><a href="../usage/9-auth.html" class="page">Authentication</a></li>
  </ul></li>
  <li><a href="../integrations/index.html" class="page">Third party Integrations</a>
  <ul>
    <li><a href="../integrations/analytics.html" class="page">Analytics</a></li>
    <li><a href="../integrations/mailgun.html" class="page">Mailgun</a></li>
    <li><a href="../integrations/statsd.html" class="page">StatsD / Datadog</a></li>
    <li><a href="../integrations/clevercloud.html" class="page">Clever Cloud</a></li>
  </ul></li>
  <li><a href="../topics/index.html" class="page">Detailed topics</a>
  <ul>
    <li><a href="../topics/snow-monkey.html" class="page">Chaos engineering with the Snow Monkey</a></li>
    <li><a href="../topics/jwt-verifications.html" class="page">JWT Tokens verification</a></li>
    <li><a href="../topics/ssl.html" class="page">SSL/TLS termination with Otoroshi</a></li>
    <li><a href="../topics/mtls.html" class="active page">Mutual TLS with Otoroshi</a></li>
    <li><a href="../topics/clustering.html" class="page">Otoroshi clustering</a></li>
    <li><a href="../topics/plugins.html" class="page">Otoroshi plugins</a></li>
    <li><a href="../topics/monitoring.html" class="page">Monitoring Otoroshi</a></li>
  </ul></li>
  <li><a href="../api.html" class="page">Admin REST API</a></li>
  <li><a href="../deploy/index.html" class="page">Deploy to production</a>
  <ul>
    <li><a href="../deploy/kubernetes.html" class="page">Kubernetes</a></li>
    <li><a href="../deploy/clevercloud.html" class="page">Clever Cloud</a></li>
    <li><a href="../deploy/aws-beanstalk.html" class="page">AWS - Elastic Beanstalk</a></li>
    <li><a href="../deploy/other.html" class="page">Others</a></li>
    <li><a href="../deploy/scaling.html" class="page">Scaling Otoroshi</a></li>
  </ul></li>
  <li><a href="../dev.html" class="page">Developing Otoroshi</a></li>
  <li><a href="../plugins/index.html" class="page">Otoroshi plugins</a>
  <ul>
    <li><a href="../plugins/otoroshi-plugins-accesslog-accesslog.html" class="page">Access log (CLF)</a></li>
    <li><a href="../plugins/otoroshi-plugins-accesslog-accesslogjson.html" class="page">Access log (JSON)</a></li>
    <li><a href="../plugins/otoroshi-plugins-users-hasallowedusersvalidator.html" class="page">Allowed users only</a></li>
    <li><a href="../plugins/otoroshi-plugins-apikeys-apikeyauthmodule.html" class="page">Apikey auth module</a></li>
    <li><a href="../plugins/otoroshi-plugins-biscuit-biscuitextractor.html" class="page">Apikey from Biscuit token extractor</a></li>
    <li><a href="../plugins/otoroshi-plugins-biscuit-biscuitvalidator.html" class="page">Biscuit token validator</a></li>
    <li><a href="../plugins/otoroshi-plugins-loggers-bodylogger.html" class="page">Body logger</a></li>
    <li><a href="../plugins/otoroshi-plugins-clientcert-hasclientcertmatchingapikeyvalidator.html" class="page">Client Certificate + Api Key only</a></li>
    <li><a href="../plugins/otoroshi-plugins-clientcert-hasclientcertvalidator.html" class="page">Client Certificate Only</a></li>
    <li><a href="../plugins/otoroshi-plugins-apikeys-clientcredentialflowextractor.html" class="page">Client Credential Flow ApiKey extractor</a></li>
    <li><a href="../plugins/otoroshi-plugins-apikeys-clientcredentialservice.html" class="page">Client Credential Service</a></li>
    <li><a href="../plugins/otoroshi-plugins-apikeys-certificateasapikey.html" class="page">Client certificate as apikey</a></li>
    <li><a href="../plugins/otoroshi-plugins-clientcert-clientcertchainheader.html" class="page">Client certificate header</a></li>
    <li><a href="../plugins/otoroshi-plugins-clientcert-hasclientcertmatchingvalidator.html" class="page">Client certificate matching</a></li>
    <li><a href="../plugins/otoroshi-plugins-clientcert-hasclientcertmatchinghttpvalidator.html" class="page">Client certificate matching (over http)</a></li>
    <li><a href="../plugins/otoroshi-plugins-defer-deferplugin.html" class="page">Defer Responses</a></li>
    <li><a href="../plugins/otoroshi-plugins-envoy-envoycontrolplane.html" class="page">Envoy Control Plane (experimental)</a></li>
    <li><a href="../plugins/otoroshi-plugins-external-externalhttpvalidator.html" class="page">External Http Validator</a></li>
    <li><a href="../plugins/otoroshi-plugins-geoloc-ipstackgeolocationinfoextractor.html" class="page">Geolocation details extractor (using IpStack api)</a></li>
    <li><a href="../plugins/otoroshi-plugins-geoloc-maxmindgeolocationinfoextractor.html" class="page">Geolocation details extractor (using Maxmind db)</a></li>
    <li><a href="../plugins/otoroshi-plugins-geoloc-geolocationinfoendpoint.html" class="page">Geolocation endpoint</a></li>
    <li><a href="../plugins/otoroshi-plugins-geoloc-geolocationinfoheader.html" class="page">Geolocation header</a></li>
    <li><a href="../plugins/otoroshi-plugins-discovery-discoveryselfregistrationsink.html" class="page">Global self registration endpoints (service discovery)</a></li>
    <li><a href="../plugins/otoroshi-plugins-jsoup-htmlpatcher.html" class="page">Html Patcher</a></li>
    <li><a href="../plugins/otoroshi-plugins-quotas-instancequotas.html" class="page">Instance quotas</a></li>
    <li><a href="../plugins/otoroshi-plugins-izanami-izanamiproxy.html" class="page">Izanami APIs Proxy</a></li>
    <li><a href="../plugins/otoroshi-plugins-izanami-izanamicanary.html" class="page">Izanami Canary Campaign</a></li>
    <li><a href="../plugins/otoroshi-plugins-jwt-jwtuserextractor.html" class="page">Jwt user extractor</a></li>
    <li><a href="../plugins/otoroshi-plugins-accesslog-kafkaaccesslog.html" class="page">Kafka access log</a></li>
    <li><a href="../plugins/otoroshi-plugins-jobs-kubernetes-kubernetesingresscontrollerjob.html" class="page">Kubernetes Ingress Controller</a></li>
    <li><a href="../plugins/otoroshi-plugins-jobs-kubernetes-kubernetesotoroshicrdscontrollerjob.html" class="page">Kubernetes Otoroshi CRDs Controller</a></li>
    <li><a href="../plugins/otoroshi-plugins-jobs-kubernetes-kubernetesadmissionwebhookcrdvalidator.html" class="page">Kubernetes admission validator webhook</a></li>
    <li><a href="../plugins/otoroshi-plugins-jobs-kubernetes-kubernetesadmissionwebhooksidecarinjector.html" class="page">Kubernetes sidecar injector webhook</a></li>
    <li><a href="../plugins/otoroshi-plugins-jobs-kubernetes-kubernetestootoroshicertsyncjob.html" class="page">Kubernetes to Otoroshi certs. synchronizer</a></li>
    <li><a href="../plugins/otoroshi-plugins-mirror-mirroringplugin.html" class="page">Mirroring plugin</a></li>
    <li><a href="../plugins/otoroshi-plugins-oidc-oidcaccesstokenasapikey.html" class="page">OIDC access_token as apikey</a></li>
    <li><a href="../plugins/otoroshi-plugins-oidc-oidcaccesstokenvalidator.html" class="page">OIDC access_token validator</a></li>
    <li><a href="../plugins/otoroshi-plugins-oidc-oidcheaders.html" class="page">OIDC headers</a></li>
    <li><a href="../plugins/otoroshi-plugins-jobs-kubernetes-otoroshitokubernetescertsyncjob.html" class="page">Otoroshi certs. to Kubernetes secrets synchronizer</a></li>
    <li><a href="../plugins/otoroshi-plugins-metrics-prometheusendpoint.html" class="page">Prometheus Endpoint</a></li>
    <li><a href="../plugins/otoroshi-plugins-metrics-prometheusservicemetrics.html" class="page">Prometheus Service Metrics</a></li>
    <li><a href="../plugins/otoroshi-plugins-quotas-servicequotas.html" class="page">Public quotas</a></li>
    <li><a href="../plugins/otoroshi-plugins-cache-responsecache.html" class="page">Response Cache</a></li>
    <li><a href="../plugins/otoroshi-plugins-security-securitytxt.html" class="page">Security Txt</a></li>
    <li><a href="../plugins/otoroshi-plugins-discovery-discoveryselfregistrationtransformer.html" class="page">Self registration endpoints (service discovery)</a></li>
    <li><a href="../plugins/otoroshi-plugins-metrics-servicemetrics.html" class="page">Service Metrics</a></li>
    <li><a href="../plugins/otoroshi-plugins-discovery-discoverytargetsselector.html" class="page">Service discovery target selector (service discovery)</a></li>
    <li><a href="../plugins/otoroshi-plugins-static-staticresponse.html" class="page">Static Response</a></li>
    <li><a href="../plugins/otoroshi-plugins-useragent-useragentextractor.html" class="page">User-Agent details extractor</a></li>
    <li><a href="../plugins/otoroshi-plugins-useragent-useragentinfoendpoint.html" class="page">User-Agent endpoint</a></li>
    <li><a href="../plugins/otoroshi-plugins-useragent-useragentinfoheader.html" class="page">User-Agent header</a></li>
    <li><a href="../plugins/otoroshi-plugins-workflow-workflowendpoint.html" class="page">Workflow endpoint</a></li>
    <li><a href="../plugins/otoroshi-plugins-workflow-workflowjob.html" class="page">Workflow job</a></li>
    <li><a href="../plugins/otoroshi-plugins-composite-compositeplugin.html" class="page">otoroshi.plugins.composite.CompositePlugin</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title-wrapper">
<div class="title-logo"></div>
<div class="title"><a href="../index.html">Otoroshi</a></div>
</div>
<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>Otoroshi
</a>
<div class="version-number">
1.5.0-beta.4
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../about.html" class="page">About Otoroshi</a></li>
  <li><a href="../archi.html" class="page">Architecture</a></li>
  <li><a href="../features.html" class="page">Features</a></li>
  <li><a href="../quickstart.html" class="page">Try Otoroshi in 5 minutes</a></li>
  <li><a href="../getotoroshi/index.html" class="page">Get Otoroshi</a>
  <ul>
    <li><a href="../getotoroshi/fromsources.html" class="page">From sources</a></li>
    <li><a href="../getotoroshi/frombinaries.html" class="page">From binaries</a></li>
    <li><a href="../getotoroshi/fromdocker.html" class="page">From docker</a></li>
  </ul></li>
  <li><a href="../firstrun/index.html" class="page">First run</a>
  <ul>
    <li><a href="../firstrun/datastore.html" class="page">Choose your datastore</a></li>
    <li><a href="../firstrun/configfile.html" class="page">Config. with files</a></li>
    <li><a href="../firstrun/env.html" class="page">Config. with ENVs</a></li>
    <li><a href="../firstrun/initialstate.html" class="page">Import initial state</a></li>
    <li><a href="../firstrun/host.html" class="page">Setup your hosts</a></li>
    <li><a href="../firstrun/run.html" class="page">Run Otoroshi</a></li>
  </ul></li>
  <li><a href="../setup/index.html" class="page">Setup Otoroshi</a>
  <ul>
    <li><a href="../setup/admin.html" class="page">Manage admin users</a></li>
    <li><a href="../setup/dangerzone.html" class="page">Configure the Danger zone</a></li>
  </ul></li>
  <li><a href="../usage/index.html" class="page">Using Otoroshi</a>
  <ul>
    <li><a href="../usage/1-groups.html" class="page">Managing service groups</a></li>
    <li><a href="../usage/2-services.html" class="page">Managing services</a></li>
    <li><a href="../usage/3-apikeys.html" class="page">Managing API keys</a></li>
    <li><a href="../usage/4-monitor.html" class="page">Monitoring services</a></li>
    <li><a href="../usage/5-sessions.html" class="page">Managing sessions</a></li>
    <li><a href="../usage/6-audit.html" class="page">Auditing Otoroshi</a></li>
    <li><a href="../usage/7-metrics.html" class="page">Otoroshi global metrics</a></li>
    <li><a href="../usage/8-importsexports.html" class="page">Import and export</a></li>
    <li><a href="../usage/9-auth.html" class="page">Authentication</a></li>
  </ul></li>
  <li><a href="../integrations/index.html" class="page">Third party Integrations</a>
  <ul>
    <li><a href="../integrations/analytics.html" class="page">Analytics</a></li>
    <li><a href="../integrations/mailgun.html" class="page">Mailgun</a></li>
    <li><a href="../integrations/statsd.html" class="page">StatsD / Datadog</a></li>
    <li><a href="../integrations/clevercloud.html" class="page">Clever Cloud</a></li>
  </ul></li>
  <li><a href="../topics/index.html" class="page">Detailed topics</a>
  <ul>
    <li><a href="../topics/snow-monkey.html" class="page">Chaos engineering with the Snow Monkey</a></li>
    <li><a href="../topics/jwt-verifications.html" class="page">JWT Tokens verification</a></li>
    <li><a href="../topics/ssl.html" class="page">SSL/TLS termination with Otoroshi</a></li>
    <li><a href="../topics/mtls.html" class="active page">Mutual TLS with Otoroshi</a></li>
    <li><a href="../topics/clustering.html" class="page">Otoroshi clustering</a></li>
    <li><a href="../topics/plugins.html" class="page">Otoroshi plugins</a></li>
    <li><a href="../topics/monitoring.html" class="page">Monitoring Otoroshi</a></li>
  </ul></li>
  <li><a href="../api.html" class="page">Admin REST API</a></li>
  <li><a href="../deploy/index.html" class="page">Deploy to production</a>
  <ul>
    <li><a href="../deploy/kubernetes.html" class="page">Kubernetes</a></li>
    <li><a href="../deploy/clevercloud.html" class="page">Clever Cloud</a></li>
    <li><a href="../deploy/aws-beanstalk.html" class="page">AWS - Elastic Beanstalk</a></li>
    <li><a href="../deploy/other.html" class="page">Others</a></li>
    <li><a href="../deploy/scaling.html" class="page">Scaling Otoroshi</a></li>
  </ul></li>
  <li><a href="../dev.html" class="page">Developing Otoroshi</a></li>
  <li><a href="../plugins/index.html" class="page">Otoroshi plugins</a>
  <ul>
    <li><a href="../plugins/otoroshi-plugins-accesslog-accesslog.html" class="page">Access log (CLF)</a></li>
    <li><a href="../plugins/otoroshi-plugins-accesslog-accesslogjson.html" class="page">Access log (JSON)</a></li>
    <li><a href="../plugins/otoroshi-plugins-users-hasallowedusersvalidator.html" class="page">Allowed users only</a></li>
    <li><a href="../plugins/otoroshi-plugins-apikeys-apikeyauthmodule.html" class="page">Apikey auth module</a></li>
    <li><a href="../plugins/otoroshi-plugins-biscuit-biscuitextractor.html" class="page">Apikey from Biscuit token extractor</a></li>
    <li><a href="../plugins/otoroshi-plugins-biscuit-biscuitvalidator.html" class="page">Biscuit token validator</a></li>
    <li><a href="../plugins/otoroshi-plugins-loggers-bodylogger.html" class="page">Body logger</a></li>
    <li><a href="../plugins/otoroshi-plugins-clientcert-hasclientcertmatchingapikeyvalidator.html" class="page">Client Certificate + Api Key only</a></li>
    <li><a href="../plugins/otoroshi-plugins-clientcert-hasclientcertvalidator.html" class="page">Client Certificate Only</a></li>
    <li><a href="../plugins/otoroshi-plugins-apikeys-clientcredentialflowextractor.html" class="page">Client Credential Flow ApiKey extractor</a></li>
    <li><a href="../plugins/otoroshi-plugins-apikeys-clientcredentialservice.html" class="page">Client Credential Service</a></li>
    <li><a href="../plugins/otoroshi-plugins-apikeys-certificateasapikey.html" class="page">Client certificate as apikey</a></li>
    <li><a href="../plugins/otoroshi-plugins-clientcert-clientcertchainheader.html" class="page">Client certificate header</a></li>
    <li><a href="../plugins/otoroshi-plugins-clientcert-hasclientcertmatchingvalidator.html" class="page">Client certificate matching</a></li>
    <li><a href="../plugins/otoroshi-plugins-clientcert-hasclientcertmatchinghttpvalidator.html" class="page">Client certificate matching (over http)</a></li>
    <li><a href="../plugins/otoroshi-plugins-defer-deferplugin.html" class="page">Defer Responses</a></li>
    <li><a href="../plugins/otoroshi-plugins-envoy-envoycontrolplane.html" class="page">Envoy Control Plane (experimental)</a></li>
    <li><a href="../plugins/otoroshi-plugins-external-externalhttpvalidator.html" class="page">External Http Validator</a></li>
    <li><a href="../plugins/otoroshi-plugins-geoloc-ipstackgeolocationinfoextractor.html" class="page">Geolocation details extractor (using IpStack api)</a></li>
    <li><a href="../plugins/otoroshi-plugins-geoloc-maxmindgeolocationinfoextractor.html" class="page">Geolocation details extractor (using Maxmind db)</a></li>
    <li><a href="../plugins/otoroshi-plugins-geoloc-geolocationinfoendpoint.html" class="page">Geolocation endpoint</a></li>
    <li><a href="../plugins/otoroshi-plugins-geoloc-geolocationinfoheader.html" class="page">Geolocation header</a></li>
    <li><a href="../plugins/otoroshi-plugins-discovery-discoveryselfregistrationsink.html" class="page">Global self registration endpoints (service discovery)</a></li>
    <li><a href="../plugins/otoroshi-plugins-jsoup-htmlpatcher.html" class="page">Html Patcher</a></li>
    <li><a href="../plugins/otoroshi-plugins-quotas-instancequotas.html" class="page">Instance quotas</a></li>
    <li><a href="../plugins/otoroshi-plugins-izanami-izanamiproxy.html" class="page">Izanami APIs Proxy</a></li>
    <li><a href="../plugins/otoroshi-plugins-izanami-izanamicanary.html" class="page">Izanami Canary Campaign</a></li>
    <li><a href="../plugins/otoroshi-plugins-jwt-jwtuserextractor.html" class="page">Jwt user extractor</a></li>
    <li><a href="../plugins/otoroshi-plugins-accesslog-kafkaaccesslog.html" class="page">Kafka access log</a></li>
    <li><a href="../plugins/otoroshi-plugins-jobs-kubernetes-kubernetesingresscontrollerjob.html" class="page">Kubernetes Ingress Controller</a></li>
    <li><a href="../plugins/otoroshi-plugins-jobs-kubernetes-kubernetesotoroshicrdscontrollerjob.html" class="page">Kubernetes Otoroshi CRDs Controller</a></li>
    <li><a href="../plugins/otoroshi-plugins-jobs-kubernetes-kubernetesadmissionwebhookcrdvalidator.html" class="page">Kubernetes admission validator webhook</a></li>
    <li><a href="../plugins/otoroshi-plugins-jobs-kubernetes-kubernetesadmissionwebhooksidecarinjector.html" class="page">Kubernetes sidecar injector webhook</a></li>
    <li><a href="../plugins/otoroshi-plugins-jobs-kubernetes-kubernetestootoroshicertsyncjob.html" class="page">Kubernetes to Otoroshi certs. synchronizer</a></li>
    <li><a href="../plugins/otoroshi-plugins-mirror-mirroringplugin.html" class="page">Mirroring plugin</a></li>
    <li><a href="../plugins/otoroshi-plugins-oidc-oidcaccesstokenasapikey.html" class="page">OIDC access_token as apikey</a></li>
    <li><a href="../plugins/otoroshi-plugins-oidc-oidcaccesstokenvalidator.html" class="page">OIDC access_token validator</a></li>
    <li><a href="../plugins/otoroshi-plugins-oidc-oidcheaders.html" class="page">OIDC headers</a></li>
    <li><a href="../plugins/otoroshi-plugins-jobs-kubernetes-otoroshitokubernetescertsyncjob.html" class="page">Otoroshi certs. to Kubernetes secrets synchronizer</a></li>
    <li><a href="../plugins/otoroshi-plugins-metrics-prometheusendpoint.html" class="page">Prometheus Endpoint</a></li>
    <li><a href="../plugins/otoroshi-plugins-metrics-prometheusservicemetrics.html" class="page">Prometheus Service Metrics</a></li>
    <li><a href="../plugins/otoroshi-plugins-quotas-servicequotas.html" class="page">Public quotas</a></li>
    <li><a href="../plugins/otoroshi-plugins-cache-responsecache.html" class="page">Response Cache</a></li>
    <li><a href="../plugins/otoroshi-plugins-security-securitytxt.html" class="page">Security Txt</a></li>
    <li><a href="../plugins/otoroshi-plugins-discovery-discoveryselfregistrationtransformer.html" class="page">Self registration endpoints (service discovery)</a></li>
    <li><a href="../plugins/otoroshi-plugins-metrics-servicemetrics.html" class="page">Service Metrics</a></li>
    <li><a href="../plugins/otoroshi-plugins-discovery-discoverytargetsselector.html" class="page">Service discovery target selector (service discovery)</a></li>
    <li><a href="../plugins/otoroshi-plugins-static-staticresponse.html" class="page">Static Response</a></li>
    <li><a href="../plugins/otoroshi-plugins-useragent-useragentextractor.html" class="page">User-Agent details extractor</a></li>
    <li><a href="../plugins/otoroshi-plugins-useragent-useragentinfoendpoint.html" class="page">User-Agent endpoint</a></li>
    <li><a href="../plugins/otoroshi-plugins-useragent-useragentinfoheader.html" class="page">User-Agent header</a></li>
    <li><a href="../plugins/otoroshi-plugins-workflow-workflowendpoint.html" class="page">Workflow endpoint</a></li>
    <li><a href="../plugins/otoroshi-plugins-workflow-workflowjob.html" class="page">Workflow job</a></li>
    <li><a href="../plugins/otoroshi-plugins-composite-compositeplugin.html" class="page">otoroshi.plugins.composite.CompositePlugin</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../index.html">Otoroshi</a></li>
  <li><a href="../topics/index.html">Detailed topics</a></li>
  <li>Mutual TLS with Otoroshi</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#mutual-tls-with-otoroshi" name="mutual-tls-with-otoroshi" class="anchor"><span class="anchor-link"></span></a>Mutual TLS with Otoroshi</h1>
<p>if you want to use MTLS on otoroshi, you first need to enable it. It is not enabled by default as it will make TLS handshake way heavier. To enable it just change the following config :</p>
<pre><code>play.server.https.wantClientAuth=true
# or
# play.server.https.wantClientNeed=true
otoroshi.ssl.fromOutside.clientAuth=None|Want|Need
</code></pre>
<p>or using env. variables</p>
<pre><code>HTTPS_WANT_CLIENT_AUTH=true 
# HTTPS_NEED_CLIENT_AUTH=true 
SSL_OUTSIDE_CLIENT_AUTH=None|Want|Need
</code></pre>
<p>you can use the <code>Want</code> setup if you cant to have both mtls on some services and no mtls on other services.</p>
<p>You can also change the trusted CA list sent in the handshake certificate request from the <code>Danger Zone</code> in <code>Tls Settings</code>.</p><div class="callout warning "><div class="callout-title">Warning</div>
<p>The following section is under rewrite. The following content is deprecated</p></div>
<p>Otoroshi support mutual TLS out of the box. mTLS from client to Otoroshi and from Otoroshi to targets are supported. In this article we will see how to configure Otoroshi to use end-to-end mTLS. All code and files used in this articles can be found on the <a href="https://github.com/MAIF/otoroshi/tree/master/demos/mtls">Otoroshi github</a></p><div class="callout note "><div class="callout-title">Experimental Feature</div>
<p>Dynamic Mutual TLS is an experimental feature. It can change until it becomess an official feature</p></div>
<h2><a href="#end-to-end-mtls" name="end-to-end-mtls" class="anchor"><span class="anchor-link"></span></a>End-to-end mTLS</h2>
<p>The use case is the following :</p><div class="centered-img">
<img src="../img/mtls-arch-1.jpg" /></div>
<p>for this demo you will have to edit your <code>/etc/hosts</code> file to add the following entries</p>
<pre><code>127.0.0.1    api.backend.lol api.frontend.lol www.backend.lol www.frontend.lol validation.backend.lol
</code></pre>
<h3><a href="#create-certificates" name="create-certificates" class="anchor"><span class="anchor-link"></span></a>Create certificates</h3>
<p>But first we need to generate some certificates to make the demo work</p>
<pre class="prettyprint"><code class="language-sh">mkdir mtls-demo
cd mtls-demo
mkdir ca
mkdir server
mkdir client

# create a certificate authority key, use password as pass phrase
openssl genrsa -out ./ca/ca-backend.key 4096
# remove pass phrase
openssl rsa -in ./ca/ca-backend.key -out ./ca/ca-backend.key
# generate the certificate authority cert
openssl req -new -x509 -sha256 -days 730 -key ./ca/ca-backend.key -out ./ca/ca-backend.cer -subj &quot;/CN=MTLSB&quot;


# create a certificate authority key, use password as pass phrase
openssl genrsa -out ./ca/ca-frontend.key 2048
# remove pass phrase
openssl rsa -in ./ca/ca-frontend.key -out ./ca/ca-frontend.key
# generate the certificate authority cert
openssl req -new -x509 -sha256 -days 730 -key ./ca/ca-frontend.key -out ./ca/ca-frontend.cer -subj &quot;/CN=MTLSF&quot;


# now create the backend cert key, use password as pass phrase
openssl genrsa -out ./server/_.backend.lol.key 2048
# remove pass phrase
openssl rsa -in ./server/_.backend.lol.key -out ./server/_.backend.lol.key
# generate the csr for the certificate
openssl req -new -key ./server/_.backend.lol.key -sha256 -out ./server/_.backend.lol.csr -subj &quot;/CN=*.backend.lol&quot;
# generate the certificate
openssl x509 -req -days 365 -sha256 -in ./server/_.backend.lol.csr -CA ./ca/ca-backend.cer -CAkey ./ca/ca-backend.key -set_serial 1 -out ./server/_.backend.lol.cer
# verify the certificate, should output &#39;./server/_.backend.lol.cer: OK&#39;
openssl verify -CAfile ./ca/ca-backend.cer ./server/_.backend.lol.cer


# now create the frontend cert key, use password as pass phrase
openssl genrsa -out ./server/_.frontend.lol.key 2048
# remove pass phrase
openssl rsa -in ./server/_.frontend.lol.key -out ./server/_.frontend.lol.key
# generate the csr for the certificate
openssl req -new -key ./server/_.frontend.lol.key -sha256 -out ./server/_.frontend.lol.csr -subj &quot;/CN=*.frontend.lol&quot;
# generate the certificate
openssl x509 -req -days 365 -sha256 -in ./server/_.frontend.lol.csr -CA ./ca/ca-frontend.cer -CAkey ./ca/ca-frontend.key -set_serial 1 -out ./server/_.frontend.lol.cer
# verify the certificate, should output &#39;./server/_.frontend.lol.cer: OK&#39;
openssl verify -CAfile ./ca/ca-frontend.cer ./server/_.frontend.lol.cer


# now create the client cert key for backend, use password as pass phrase
openssl genrsa -out ./client/_.backend.lol.key 2048
# remove pass phrase
openssl rsa -in ./client/_.backend.lol.key -out ./client/_.backend.lol.key
# generate the csr for the certificate
openssl req -new -key ./client/_.backend.lol.key -out ./client/_.backend.lol.csr -subj &quot;/CN=*.backend.lol&quot;
# generate the certificate
openssl x509 -req -days 365 -sha256 -in ./client/_.backend.lol.csr -CA ./ca/ca-backend.cer -CAkey ./ca/ca-backend.key -set_serial 2 -out ./client/_.backend.lol.cer
# generate a pkcs12 version of the cert and key, use password as password
openssl pkcs12 -export -clcerts -in client/_.backend.lol.cer -inkey client/_.backend.lol.key -out client/_.backend.lol.p12


# now create the client cert key for frontend, use password as pass phrase
openssl genrsa -out ./client/_.frontend.lol.key 2048
# remove pass phrase
openssl rsa -in ./client/_.frontend.lol.key -out ./client/_.frontend.lol.key
# generate the csr for the certificate
openssl req -new -key ./client/_.frontend.lol.key -out ./client/_.frontend.lol.csr -subj &quot;/CN=*.frontend.lol&quot;
# generate the certificate
openssl x509 -req -days 365 -sha256 -in ./client/_.frontend.lol.csr -CA ./ca/ca-frontend.cer -CAkey ./ca/ca-frontend.key -set_serial 2 -out ./client/_.frontend.lol.cer
# generate a pkcs12 version of the cert and key, use password as password
openssl pkcs12 -export -clcerts -in client/_.frontend.lol.cer -inkey client/_.frontend.lol.key -out client/_.frontend.lol.p12
</code></pre>
<p>once it&rsquo;s done, you should have something like</p>
<pre class="prettyprint"><code class="language-sh">$ tree
.
├── backend.js
├── ca
│   ├── ca-backend.cer
│   ├── ca-backend.key
│   ├── ca-frontend.cer
│   └── ca-frontend.key
├── client
│   ├── _.backend.lol.cer
│   ├── _.backend.lol.csr
│   ├── _.backend.lol.key
│   ├── _.backend.lol.p12
│   ├── _.frontend.lol.cer
│   ├── _.frontend.lol.csr
│   ├── _.frontend.lol.key
│   └── _.frontend.lol.p12
└── server
    ├── _.backend.lol.cer
    ├── _.backend.lol.csr
    ├── _.backend.lol.key
    ├── _.frontend.lol.cer
    ├── _.frontend.lol.csr
    └── _.frontend.lol.key

3 directories, 18 files
</code></pre>
<h3><a href="#the-backend-service" name="the-backend-service" class="anchor"><span class="anchor-link"></span></a>The backend service</h3>
<p>now, let&rsquo;s create a backend service using nodejs. Create a file named <code>backend.js</code></p>
<pre class="prettyprint"><code class="language-sh">touch backend.js
</code></pre>
<p>and put the following content</p>
<pre class="prettyprint"><code class="language-js">const fs = require(&#39;fs&#39;); 
const https = require(&#39;https&#39;); 

const options = { 
  key: fs.readFileSync(&#39;./server/_.backend.lol.key&#39;), 
  cert: fs.readFileSync(&#39;./server/_.backend.lol.cer&#39;), 
  ca: fs.readFileSync(&#39;./ca/ca-backend.cer&#39;), 
}; 

https.createServer(options, (req, res) =&gt; { 
  res.writeHead(200, {
    &#39;Content-Type&#39;: &#39;application/json&#39;
  }); 
  res.end(JSON.stringify({ message: &#39;Hello World!&#39; }) + &quot;\n&quot;); 
}).listen(8444);
</code></pre>
<p>to run the server, just do </p>
<pre class="prettyprint"><code class="language-sh">node ./backend.js
</code></pre>
<p>now you can try your server with</p>
<pre class="prettyprint"><code class="language-sh">curl --cacert ./ca/ca-backend.cer https://api.backend.lol:8444/
# will print {&quot;message&quot;:&quot;Hello World!&quot;}
</code></pre>
<p>now modify your backend server to ensure that the client provides a client certificate like:</p>
<pre class="prettyprint"><code class="language-js">const fs = require(&#39;fs&#39;); 
const https = require(&#39;https&#39;); 

const options = { 
  key: fs.readFileSync(&#39;./server/_.backend.lol.key&#39;), 
  cert: fs.readFileSync(&#39;./server/_.backend.lol.cer&#39;), 
  ca: fs.readFileSync(&#39;./ca/ca-backend.cer&#39;), 
  requestCert: true, 
  rejectUnauthorized: true
}; 

https.createServer(options, (req, res) =&gt; { 
  console.log(&#39;Client certificate CN: &#39;, req.socket.getPeerCertificate().subject.CN);
  res.writeHead(200, {
    &#39;Content-Type&#39;: &#39;application/json&#39;
  }); 
  res.end(JSON.stringify({ message: &#39;Hello World!&#39; }) + &quot;\n&quot;); 
}).listen(8444);
</code></pre>
<p>you can test your new server with</p>
<pre class="prettyprint"><code class="language-sh">curl --cacert ./ca/ca-backend.cer --cert-type pkcs12 --cert ./client/_.backend.lol.p12:password https://api.backend.lol:8444/
# will print {&quot;message&quot;:&quot;Hello World!&quot;}
</code></pre>
<h3><a href="#otoroshi-setup" name="otoroshi-setup" class="anchor"><span class="anchor-link"></span></a>Otoroshi setup</h3>
<p>Download the latest version of the Otoroshi jar and run it like</p>
<pre class="prettyprint"><code class="language-sh">java -jar otoroshi.jar

[info] otoroshi-env - Admin API exposed on http://otoroshi-api.oto.tools:8080
[info] otoroshi-env - Admin UI  exposed on http://otoroshi.oto.tools:8080
[info] otoroshi-in-memory-datastores - Now using InMemory DataStores
[info] otoroshi-env - The main datastore seems to be empty, registering some basic services
[info] otoroshi-env - You can log into the Otoroshi admin console with the following credentials: admin@otoroshi.io / xxxxxxxxxxxx
[info] play.api.Play - Application started (Prod)
[info] p.c.s.AkkaHttpServer - Listening for HTTP on /0:0:0:0:0:0:0:0:8080
[info] p.c.s.AkkaHttpServer - Listening for HTTPS on /0:0:0:0:0:0:0:0:8443
[info] otoroshi-env - Generating a self signed SSL certificate for https://*.oto.tools ...
</code></pre>
<p>and log into otoroshi with the tuple <code>admin@otoroshi.io / xxxxxxxxxxxx</code> displayed in the logs. Once logged in, create a new public service exposed on <code>http://api.frontend.lol</code> that targets <code>ahttps://api.backend.lol:8444/</code>.</p><div class="centered-img">
<img src="../img/mtls-service-1.png" /></div>
<p>and test it</p>
<pre class="prettyprint"><code class="language-sh">curl http://api.frontend.lol:8080/
# the following error should be returned: {&quot;Otoroshi-Error&quot;:&quot;Something went wrong, you should try later. Thanks for your understanding.&quot;}
</code></pre><div class="callout warning "><div class="callout-title">Warning</div>
<p>As seen before, the target of the otoroshi service is <code>ahttps://api.backend.lol:8444/</code>. <code>ahttps://</code> is not a typo and is intended. This tells otoroshi to use its experimental <code>http client</code> with dynamic tls support to fetch this resource.</p></div>
<p>you should get an error due to the fact that Otoroshi doesn&rsquo;t know about the server certificate or the client certificate expected by the server.</p>
<p>We have to add the client certificate for <code>https://api.backend.lol</code> to Otoroshi. Go to <a href="http://otoroshi.oto.tools:8080/bo/dashboard/certificates">http://otoroshi.oto.tools:8080/bo/dashboard/certificates</a> and create a new item. Copy and paste the content of <code>./client/_.backend.lol.cer</code> and <code>./client/_.backend.lol.key</code> respectively in <code>Certificate full chain</code> and <code>Certificate private key</code>.</p><div class="centered-img">
<img src="../img/mtls-cert-client-backend-1.png" /></div>
<p>and retry the following curl command </p>
<pre class="prettyprint"><code class="language-sh">curl http://api.frontend.lol:8080/
# the output should be: {&quot;message&quot;:&quot;Hello World!&quot;}
</code></pre>
<p>now we have to expose <code>https://api.frontend.lol:8443</code> using otoroshi. Go to <a href="http://otoroshi.oto.tools:8080/bo/dashboard/certificates">http://otoroshi.oto.tools:8080/bo/dashboard/certificates</a> and create a new item. Copy and paste the content of <code>./server/_.frontend.lol.cer</code> and <code>./server/_.frontend.lol.key</code> respectively in <code>Certificate full chain</code> and <code>Certificate private key</code>.</p>
<p>and try the following command</p>
<pre class="prettyprint"><code class="language-sh">curl --cacert ./ca/ca-frontend.cer https://api.frontend.lol:8443/
# the output should be: {&quot;message&quot;:&quot;Hello World!&quot;}
</code></pre>
<p>now we have to enforce the fact that we want client certificate for <code>api.frontend.lol</code>. To do that, we have to create a <code>Validation authority</code> in otoroshi and use it on the <code>api.frontend.lol</code> service. Go to <a href="http://otoroshi.oto.tools:8080/bo/dashboard/validation-authorities">http://otoroshi.oto.tools:8080/bo/dashboard/validation-authorities</a> and create a new item. A validation authority is supposed to be a remote service that will say if the client certificate is valid. Here we don&rsquo;t really care if the certificate is valid or not, but we want to enforce the fact that there is a client certificate. So just check the <code>All cert. valid button</code>.</p><div class="centered-img">
<img src="../img/mtls-va-1.png" /></div>
<p>now go back on your <code>api.frontend.lol</code> service, in the <code>Validation authority</code> section and select the authority you just created.</p><div class="centered-img">
<img src="../img/mtls-va-ref-1.png" /></div>
<p>now if you retry </p>
<pre class="prettyprint"><code class="language-sh">curl --cacert ./ca/ca-frontend.cer https://api.frontend.lol:8443/
# the output should be: {&quot;Otoroshi-Error&quot;:&quot;You&#39;re not authorized here !&quot;}
</code></pre>
<p>you should get an error because no client cert. is passed with the request. But if you pass the <code>./client/_.frontend.lol.p12</code> client cert in your curl call</p>
<pre class="prettyprint"><code class="language-sh">curl --cacert ./ca/ca-frontend.cer --cert-type pkcs12 --cert ./client/_.frontend.lol.p12:password https://api.frontend.lol:8443/
# the output should be: {&quot;message&quot;:&quot;Hello World!&quot;}
</code></pre>
<h3><a href="#end-to-end-test" name="end-to-end-test" class="anchor"><span class="anchor-link"></span></a>End to end test</h3>
<p>Now we can try to write a small nodejs client that uses our client certificates. Create a <code>client.js</code> file with the following code</p>
<pre class="prettyprint"><code class="language-js">const fs = require(&#39;fs&#39;); 
const https = require(&#39;https&#39;); 

process.env[&#39;NODE_TLS_REJECT_UNAUTHORIZED&#39;] = 0;

const options = { 
  hostname: &#39;api.frontend.lol&#39;, 
  port: 8443, 
  path: &#39;/&#39;, 
  method: &#39;GET&#39;, 
  key: fs.readFileSync(&#39;./client/_.frontend.lol.key&#39;), 
  cert: fs.readFileSync(&#39;./client/_.frontend.lol.cer&#39;), 
  ca: fs.readFileSync(&#39;./ca/ca-frontend.cer&#39;), 
}; 

const req = https.request(options, (res) =&gt; { 
  console.log(&#39;statusCode&#39;, res.statusCode);
  console.log(&#39;headers&#39;, res.headers);
  console.log(&#39;body:&#39;);
  res.on(&#39;data&#39;, (data) =&gt; { 
    process.stdout.write(data); 
  }); 
}); 

req.end(); 

req.on(&#39;error&#39;, (e) =&gt; { 
  console.error(e); 
});
</code></pre>
<p>and run the following command</p>
<pre class="prettyprint"><code class="language-sh">$ node client.js
# statusCode 200
# headers { date: &#39;Mon, 10 Dec 2018 16:01:11 GMT&#39;,
#   connection: &#39;close&#39;,
#   &#39;transfer-encoding&#39;: &#39;chunked&#39;,
#   &#39;content-type&#39;: &#39;application/json&#39; }
# body:
# {&quot;message&quot;:&quot;Hello World!&quot;}
</code></pre>
<p>And that&rsquo;s it </p>
<h2><a href="#validating-client-certificates-based-on-user-identity" name="validating-client-certificates-based-on-user-identity" class="anchor"><span class="anchor-link"></span></a>Validating client certificates based on user identity</h2><div class="callout note "><div class="callout-title">Experimental Feature</div>
<p>Validation authorities is an experimental feature. It can change until it becomess an official feature</p></div>
<p>The use case is the following :</p><div class="centered-img">
<img src="../img/mtls-arch-2.jpg" /></div>
<p>the idea here is to provide a unique client certificate per device that can access Otoroshi and use a validation authority to check if the user is allowed to access the underlying app with a specific device.</p>
<h3><a href="#generate-client-certificates-for-devices" name="generate-client-certificates-for-devices" class="anchor"><span class="anchor-link"></span></a>Generate client certificates for devices</h3>
<p>To do that we are going to create two client certificates, one per device (let say for a laptop and a desktop computer). We are going to use the device serial number as common name of the certificate to be able to identify the device behind the certificate.</p>
<pre class="prettyprint"><code class="language-sh">openssl genrsa -out ./client/device-1.key 2048
openssl rsa -in ./client/device-1.key -out ./client/device-1.key
openssl req -new -key ./client/device-1.key -out ./client/device-1.csr -subj &quot;/CN=mbp-123456789&quot;
openssl x509 -req -days 365 -sha256 -in ./client/device-1.csr -CA ./ca/ca-frontend.cer -CAkey ./ca/ca-frontend.key -set_serial 3 -out ./client/device-1
openssl pkcs12 -export -clcerts -in client/device-1 -inkey client/device-1.key -out client/device-1.p12

openssl genrsa -out ./client/device-2.key 2048
openssl rsa -in ./client/device-2.key -out ./client/device-2.key
openssl req -new -key ./client/device-2.key -out ./client/device-2.csr -subj &quot;/CN=nuc-987654321&quot;
openssl x509 -req -days 365 -sha256 -in ./client/device-2.csr -CA ./ca/ca-frontend.cer -CAkey ./ca/ca-frontend.key -set_serial 4 -out ./client/device-2
openssl pkcs12 -export -clcerts -in client/device-2 -inkey client/device-2.key -out client/device-2.p12
</code></pre>
<h3><a href="#setup-actual-validation" name="setup-actual-validation" class="anchor"><span class="anchor-link"></span></a>Setup actual validation</h3>
<p>now we are going to write an validation authority (with mTLS too) that is going to respond on <code>https://validation.backend.lol:8445</code>. The server has access to a list of apps, users and devices to check if everything is correct. In this implementation, the lists are hardcoded, but you can write your own implementation that will fetch data from your corporate LDAP, CA, etc. Create a <code>validation.js</code> file and add the following content. Don&rsquo;t forget to do <code>yarn add x509</code> before running the server with <code>node validation.js</code></p>
<pre class="prettyprint"><code class="language-js">const fs = require(&#39;fs&#39;); 
const https = require(&#39;https&#39;); 
const x509 = require(&#39;x509&#39;);

// list of knwon apps
const apps = [
  {
    &quot;id&quot;: &quot;iogOIDH09EktFhydTp8xspGvdaBq961DUDr6MBBNwHO2EiBMlOdafGnImhbRGy8z&quot;,
    &quot;name&quot;: &quot;my-web-service&quot;,
    &quot;description&quot;: &quot;A service that says hello&quot;,
    &quot;host&quot;: &quot;www.frontend.lol&quot;
  }
];

// list of known users
const users = [
  {
    &quot;name&quot;: &quot;Mathieu&quot;,
    &quot;email&quot;: &quot;mathieu@oto.tools&quot;,
    &quot;appRights&quot;: [
      {
        &quot;id&quot;: &quot;iogOIDH09EktFhydTp8xspGvdaBq961DUDr6MBBNwHO2EiBMlOdafGnImhbRGy8z&quot;,
        &quot;profile&quot;: &quot;user&quot;,
        &quot;forbidden&quot;: false
      },
      {
        &quot;id&quot;: &quot;PqgOIDH09EktFhydTp8xspGvdaBq961DUDr6MBBNwHO2EiBMlOdafGnImhbRGy8z&quot;,
        &quot;profile&quot;: &quot;none&quot;,
        &quot;forbidden&quot;: true
      },
    ],
    &quot;ownedDevices&quot;: [
      &quot;mbp-123456789&quot;,
      &quot;nuc-987654321&quot;,
    ]
  }
];

// list of known devices
const devices = [
  {
    &quot;serialNumber&quot;: &quot;mbp-123456789&quot;,
    &quot;hardware&quot;: &quot;Macbook Pro 2018 13 inc. with TouchBar, 2.6 GHz, 16 Gb&quot;,
    &quot;acquiredAt&quot;: &quot;2018-10-01&quot;,
  },
  {
    &quot;serialNumber&quot;: &quot;nuc-987654321&quot;,
    &quot;hardware&quot;: &quot;Intel NUC i7 3.0 GHz, 32 Gb&quot;,
    &quot;acquiredAt&quot;: &quot;2018-09-01&quot;,
  },
  {
    &quot;serialNumber&quot;: &quot;iphone-1234&quot;,
    &quot;hardware&quot;: &quot;Iphone XS, 256 Gb&quot;,
    &quot;acquiredAt&quot;: &quot;2018-12-01&quot;,
  }
];

const options = { 
  key: fs.readFileSync(&#39;./server/_.backend.lol.key&#39;), 
  cert: fs.readFileSync(&#39;./server/_.backend.lol.cer&#39;), 
  ca: fs.readFileSync(&#39;./ca/ca-backend.cer&#39;), 
  requestCert: true, 
  rejectUnauthorized: true
}; 

function readBody(request) {
  return new Promise((success, failure) =&gt; {
    const body = [];
    request.on(&#39;data&#39;, (chunk) =&gt; {
      body.push(chunk);
    }).on(&#39;end&#39;, () =&gt; {
      const bodyStr = Buffer.concat(body).toString();
      success(JSON.parse(bodyStr));
    });
  });
}

function chainIsValid(chain) {
  // validate cert dates
  // validate cert against clr
  // validate whatever you want here
  return true;
}

function call(req, res) {
  readBody(req).then(body =&gt; {
    const service = body.service;
    const email = (body.user || { email: &#39;mathieu@oto.tools&#39; }).email; // here, should not be null if used with an otoroshi auth. module
    // common name should be device serial number
    const commonName = x509.getSubject(body.chain).commonName
    // search for a known device
    const device = devices.filter(d =&gt; d.serialNumber === commonName)[0];
    // search for a known user
    const user = users.filter(d =&gt; d.email === email)[0];
    // search for a known application
    const app = apps.filter(d =&gt; d.id === service.id)[0];
    res.writeHead(200, { &#39;Content-Type&#39;: &#39;application/json&#39; }); 
    if (chainIsValid(body.chain.map(x509.parseCert)) &amp;&amp; user &amp;&amp; device &amp;&amp; app) {
      // check if the user actually owns the device
      const userOwnsDevice = user.ownedDevices.filter(d =&gt; d === device.serialNumber)[0];
      // check if the user has rights to access the app
      const rights = user.appRights.filter(d =&gt; d.id === app.id)[0];
      const hasRightToUseApp = !rights.forbidden
      if (userOwnsDevice &amp;&amp; hasRightToUseApp) {
        // yeah !!!!
        console.log(`Call from user &quot;${user.email}&quot; with device &quot;${device.hardware}&quot; on app &quot;${app.name}&quot; with profile &quot;${rights.profile}&quot; authorized`)
        res.end(JSON.stringify({ status: &#39;good&#39;, profile: rights.profile }) + &quot;\n&quot;); 
      } else {
        // nope !!! nope, nope nope
        console.log(`Call from user &quot;${user.email}&quot; with device &quot;${device.hardware}&quot; on app &quot;${app.name}&quot; unauthorized because user doesn&#39;t owns the hardware or has no rights`)
        res.end(JSON.stringify({ status: &#39;unauthorized&#39; }) + &quot;\n&quot;); 
      }
    } else {
      console.log(`Call unauthorized`)
      res.end(JSON.stringify({ status: &#39;unauthorized&#39; }) + &quot;\n&quot;); 
    }
  });
}

https.createServer(options, call).listen(8445);
</code></pre>
<p>the corresponding authority validation can be created in Otoroshi like </p>
<pre class="prettyprint"><code class="language-json">{
  &quot;id&quot;: &quot;r7m8j31rh66hhdia3ormfm0wfevu1kvg0zgaxsp3oxb6ivf7fy8kvygmvnrlxv81&quot;,
  &quot;name&quot;: &quot;Actual validation authority&quot;,
  &quot;description&quot;: &quot;Actual validation authority&quot;,
  &quot;url&quot;: &quot;ahttps://validation.backend.lol:8445&quot;,
  &quot;host&quot;: &quot;validation.backend.lol&quot;,
  &quot;goodTtl&quot;: 600000,
  &quot;badTtl&quot;: 60000,
  &quot;method&quot;: &quot;POST&quot;,
  &quot;path&quot;: &quot;/certificates/_validate&quot;,
  &quot;timeout&quot;: 10000,
  &quot;noCache&quot;: false,
  &quot;alwaysValid&quot;: false,
  &quot;headers&quot;: {}
}
</code></pre>
<p>but you don&rsquo;t need to create it right now.</p>
<p>Typically, a validation authority server is a server with a route on <code>POST /certificates/_validate</code> that accepts <code>application/json</code> and returns <code>application/json</code> with a body like</p>
<pre class="prettyprint"><code class="language-json">{
  &quot;apikey&quot;: nullable {
    &quot;clientId&quot;: String,
    &quot;clientName&quot;: String,
    &quot;authorizedEntities&quot;: Seq[String],
    &quot;enabled&quot;: Boolean,
    &quot;readOnly&quot;: Boolean,
    &quot;allowClientIdOnly&quot;: Boolean,
    &quot;throttlingQuota&quot;: Long,
    &quot;dailyQuota&quot;: Long,
    &quot;monthlyQuota&quot;: Long,
    &quot;metadata&quot;: Map[String, String]
  },
  &quot;user&quot;: nullable {
    &quot;email&quot;: String,
    &quot;name&quot;: String,
  },
  &quot;service&quot;: {
    &quot;id&quot;: String,
    &quot;name&quot;: String,
    &quot;groups&quot;: Seq[String],
    &quot;domain&quot;: String,
    &quot;env&quot;: String,
    &quot;subdomain&quot;: String,
    &quot;root&quot;: String,
    &quot;metadata&quot;: String
  },
  &quot;chain&quot;: PemFormattedCertificateChainString,
  &quot;fingerprints&quot;: Array[String]
}
</code></pre>
<h3><a href="#setup-otoroshi" name="setup-otoroshi" class="anchor"><span class="anchor-link"></span></a>Setup Otoroshi</h3>
<p>You can start Otoroshi and import data from the <code>state.json</code> file in the demo folder. The login tuple is <code>admin@otoroshi.io / password</code>. The <code>state.json</code> file contains everything you need for the demo, like certificates, service descriptors, auth. modules, etc &hellip;</p>
<pre class="prettyprint"><code class="language-sh">java -Dapp.importFrom=$(pwd)/state.json -Dapp.privateapps.port=8080 -jar otoroshi.jar

[info] otoroshi-env - Admin API exposed on http://otoroshi-api.oto.tools:8080
[info] otoroshi-env - Admin UI  exposed on http://otoroshi.oto.tools:8080
[info] otoroshi-in-memory-datastores - Now using InMemory DataStores
[info] otoroshi-env - The main datastore seems to be empty, registering some basic services
[info] otoroshi-env - Importing from: /pwd/state.json
[info] play.api.Play - Application started (Prod)
[info] otoroshi-env - Successful import !
[info] p.c.s.AkkaHttpServer - Listening for HTTP on /0:0:0:0:0:0:0:0:8080
[info] p.c.s.AkkaHttpServer - Listening for HTTPS on /0:0:0:0:0:0:0:0:8443
</code></pre>
<h3><a href="#testing" name="testing" class="anchor"><span class="anchor-link"></span></a>Testing</h3>
<p>You can test the service with curl like</p>
<pre class="prettyprint"><code class="language-sh">curl --cacert ./ca/ca-frontend.cer --cert-type pkcs12 --cert ./client/device-1.p12:password https://www.frontend.lol:8443/
# output: &lt;h1&gt;Hello World !!!&lt;/h1&gt;
curl --cacert ./ca/ca-frontend.cer --cert-type pkcs12 --cert ./client/device-2.p12:password https://www.frontend.lol:8443/
# output: &lt;h1&gt;Hello World !!!&lt;/h1&gt;
curl --cacert ./ca/ca-frontend.cer --cert-type pkcs12 --cert ./client/_.frontend.lol.p12:password https://www.frontend.lol:8443/
# output: {&quot;Otoroshi-Error&quot;:&quot;You&#39;re not authorized here !&quot;}
</code></pre>
<p>as expected, the first two call works as their common name is known by the validation server. The last one fails as it&rsquo;s not known.</p>
<h3><a href="#validate-user-identity" name="validate-user-identity" class="anchor"><span class="anchor-link"></span></a>Validate user identity</h3>
<p>Now let&rsquo;s try to setup firefox to provide the client certificate. Open firefox settings, go to <code>privacy settings and security</code> and click on <code>display certificates</code> at the bottom of the page. Here you can add the frontend CA (<code>./ca/ca-frontend.cer</code>) in the <code>Authorities</code> tab, check the &lsquo;authorize this CA to identify websites&rsquo;, and then in the <code>certificates</code> tab, import one of the devices <code>.p12</code> file (like <code>./client/device-1.p12</code>). Firefox will ask for the files password (it should be <code>password</code>).</p><div class="centered-img">
<img src="../img/mtls-ff-1.png" /></div>
<p>Now restart firefox.</p>
<p>Next, go to the <code>my-web-service</code> service in otoroshi (log in with <code>admin@otoroshi.io / password</code>) and activate <code>Enforce user login</code> in the Authentication section. It means that now, you&rsquo;ll have to log in when you&rsquo;ll go to <a href="https://www.frontend.lol:8443">https://www.frontend.lol:8443</a>. With authentication activated on otoroshi, the user identity will be sent to the validation authority, so you can change the following line in the file <code>validation.js</code></p>
<pre class="prettyprint"><code class="language-js">const email = (body.user || { email: &#39;mathieu@oto.tools&#39; }).email; // here, should not be null if used with an otoroshi auth. module
</code></pre>
<p>to</p>
<pre class="prettyprint"><code class="language-js">const email = body.user.email;
</code></pre>
<p>Then, in Firefox, go to <a href="https://www.frontend.lol:8443/">https://www.frontend.lol:8443/</a>, firefox will ask which client certificate to use. Select the one you imported (in the process, maybe firefox will warn you that the certificate of the site is auto signed, just ignore it and continue ;) )</p><div class="centered-img">
<img src="../img/mtls-ff-2.png" /></div>
<p>then, you&rsquo;ll see a login screen from otoroshi. You can log in with <code>mathieu@oto.tools / password</code> and then you should see the hello world message.</p><div class="centered-img">
<img src="../img/mtls-ff-3.png" /></div>
<h3><a href="#going-further-with-user-authentication" name="going-further-with-user-authentication" class="anchor"><span class="anchor-link"></span></a>Going further with user authentication</h3>
<p>For stronger user authentication, you can try to use an auth. module baked by a keycloak instance with yubikey as a strong second factor authentication instead of the basic auth. module we used previously in this article.</p>
<div class="nav-next">
<p><strong>Next:</strong> <a href="../topics/clustering.html">Otoroshi clustering</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../topics/mtls.html#mutual-tls-with-otoroshi" class="header">Mutual TLS with Otoroshi</a>
  <ul>
    <li><a href="../topics/mtls.html#end-to-end-mtls" class="header">End-to-end mTLS</a></li>
    <li><a href="../topics/mtls.html#validating-client-certificates-based-on-user-identity" class="header">Validating client certificates based on user identity</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2021</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/elasticlunr/0.9.5/elasticlunr.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-112498312-1"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'UA-112498312-1');
</script>
</html>




